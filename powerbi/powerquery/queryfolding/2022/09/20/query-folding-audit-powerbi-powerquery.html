<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Function To Audit Datasources For Query Folding</h1><p class="page-description">Functions to quickly check which of the data sources are folding</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-09-20T00:00:00-05:00" itemprop="datePublished">
        Sep 20, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      3 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#powerbi">powerbi</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#powerquery">powerquery</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#queryfolding">queryfolding</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/pawarbi/blog/tree/master/_notebooks/2022-09-20-query-folding-audit-powerbi-powerquery.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/pawarbi/blog/master?filepath=_notebooks%2F2022-09-20-query-folding-audit-powerbi-powerquery.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/pawarbi/blog/blob/master/_notebooks/2022-09-20-query-folding-audit-powerbi-powerquery.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#Query-Folding">Query Folding </a></li>
<li class="toc-entry toc-h2"><a href="#Query-Folding-Audit">Query Folding Audit </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Value.Metadata">Value.Metadata </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Function-1:-__QFIndicator">Function 1: __QFIndicator </a></li>
<li class="toc-entry toc-h2"><a href="#Function-2:-__QFAudit">Function 2: __QFAudit </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Steps">Steps </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Resources">Resources </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-09-20-query-folding-audit-powerbi-powerquery.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Query-Folding">
<a class="anchor" href="#Query-Folding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Query Folding<a class="anchor-link" href="#Query-Folding"> </a>
</h2>
<p>I will assume you already know what is query folding. If you don't, please read <a href="https://learn.microsoft.com/en-us/power-query/query-folding-examples">this documentation</a> or <a href="https://player.vimeo.com/video/714177719?h=466f2d1c1b">watch the session</a> I presented few months ago. I have included more resources at the bottom.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Query-Folding-Audit">
<a class="anchor" href="#Query-Folding-Audit" aria-hidden="true"><span class="octicon octicon-link"></span></a>Query Folding Audit<a class="anchor-link" href="#Query-Folding-Audit"> </a>
</h2>
<p>Imagine a scenario where you are revisiting one of your old reports or are helping a client optimize their dataset performance. One of the first things you will look at are which of the queries are folding. If the query is folding, Power BI will offload all or part of the transformations back to the datasource thus resulting in faster refreshes. If you just have couple of data sources, you can check it by right clicking or using other methods I described in the video above. But if you have 20-30 queries, which is not uncommon, it will take time. What if there was a quick way so you can prioritize which queries to check ? The functions I wrote below will do exactly that.</p>
<h4 id="Value.Metadata">
<a class="anchor" href="#Value.Metadata" aria-hidden="true"><span class="octicon octicon-link"></span></a>Value.Metadata<a class="anchor-link" href="#Value.Metadata"> </a>
</h4>
<p>The function relies on two M functions. <code>Value.Metadata</code> which checks if the query is folding. And using <code>#section</code> to get list of all the queries. You can read more about <code>Value.Metadata</code> on Chris Webb's blog <a href="https://blog.crossjoin.co.uk/2016/08/02/another-way-to-check-query-folding-in-power-bipower-query-m-code/">here</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Function-1:-__QFIndicator">
<a class="anchor" href="#Function-1:-__QFIndicator" aria-hidden="true"><span class="octicon octicon-link"></span></a>Function 1: __QFIndicator<a class="anchor-link" href="#Function-1:-__QFIndicator"> </a>
</h2>
<p>This function uses <code>Value.Metadata</code> to check if query is folding or is foldable. If it returns <code>FALSE</code>, either the datasource is not foldable (such as Excel, CSV etc.) or the query is not folding. 
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 01-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 01-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg>
    <strong>Note: </strong>Value.Metadata function may not always work. There are scenarios where the query could be folding but it still might return <code>FALSE</code>. BigQuery, OData are some examples of that. 
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>// Save as __QFIndicator                
(tableName as table) =&gt;
  let
    fn =
      if (Value.Metadata(tableName)[QueryFolding][IsFolded] = true) then
        "Query Folded Successfully"
      else
        error Error.Record(
          "Query Folding Warning",
          "Query not folding",
          "Either the query does not use native query (i.e SQL) or the transformations are not foldable. If you are using SQL, check the query logs"
        )
  in
    fn</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Function-2:-__QFAudit">
<a class="anchor" href="#Function-2:-__QFAudit" aria-hidden="true"><span class="octicon octicon-link"></span></a>Function 2: __QFAudit<a class="anchor-link" href="#Function-2:-__QFAudit"> </a>
</h2>
<p>This function applies the above <code>__QFIndicator</code> function on all the queries returned by the <code>#Section</code> function and gives you a sorted list.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>// Save as __QFAudit
(optional RunFn as text) =&gt;
  let
    Source = #sections[Section1], 
    #"Converted to Table" = Record.ToTable(Source), 
    #"Removed Errors" = Table.RemoveRowsWithErrors(#"Converted to Table"), 
    #"Added Custom" = Table.AddColumn(
            #"Removed Errors", 
            "IsTable", 
            each [Value] is table, 
            type logical
    ), 
    #"Filtered Rows" = Table.SelectRows(#"Added Custom", each ([IsTable] = true)), 
    QFCheck = Table.AddColumn(
            #"Filtered Rows", 
            "QF Check", 
             each try __QFIndicator([Value]) otherwise Character.FromNumber(10060) &amp; " Check the query", 
            type text
    ), 
    Result = Table.Sort(QFCheck, QF Check)
  in
    Result</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://raw.githubusercontent.com/pawarbi/blog/master/images/qf1.png" alt="qf1"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Steps">
<a class="anchor" href="#Steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Steps<a class="anchor-link" href="#Steps"> </a>
</h4>
<ol>
<li>Just save these two functions in PowerQuery</li>
<li>Click <code>Invoke</code> on <code>__QFAudit</code> function</li>
<li>It will return a table that looks like below. </li>
<li>Note that the table doesn't say query is <strong>not folding</strong>. It's prompting you to check the query. In some cases your data source may not support folding and in other query could be folding but <code>Value.Metadata</code> may not be able to pick it up. That's just the limitation of the function. You will get the same results in Dataflow where Query Folding indicator is available. </li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://raw.githubusercontent.com/pawarbi/blog/master/images/qf2.png" alt="qf2"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 01-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 01-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg>
    <strong>Note: </strong>Another limitation here is that if you add a new query, you will have to invoke the function again. The results of the <code>#section</code> are not available in modeling fields and it won’t refresh automatically. This is a helper function. You can read more about it <a href="https://bengribaudo.com/blog/2021/07/12/5809/power-query-m-primer-part21-identifier-scope-sections">here</a>.
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Resources">
<a class="anchor" href="#Resources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Resources<a class="anchor-link" href="#Resources"> </a>
</h2>
<ol>
<li>My session on Query Folding : <a href="https://player.vimeo.com/video/714177719?h=466f2d1c1b">https://player.vimeo.com/video/714177719?h=466f2d1c1b</a>
</li>
<li>Chris Webb's Blog : <a href="https://blog.crossjoin.co.uk/2016/08/02/another-way-to-check-query-folding-in-power-bipower-query-m-code/">https://blog.crossjoin.co.uk/2016/08/02/another-way-to-check-query-folding-in-power-bipower-query-m-code/</a>
</li>
<li>30 Day Query Folding Challenge : <a href="https://www.youtube.com/watch?v=9sV3hIn8VTY">https://www.youtube.com/watch?v=9sV3hIn8VTY</a>
</li>
<li>Nikola's blog: <a href="https://data-mozart.com/query-folding-devil-is-in-the-detail/">https://data-mozart.com/query-folding-devil-is-in-the-detail/</a>
</li>
<li>Query Folding Guidance: <a href="https://learn.microsoft.com/en-us/power-bi/guidance/power-query-folding">https://learn.microsoft.com/en-us/power-bi/guidance/power-query-folding</a>
</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://raw.githubusercontent.com/pawarbi/blog/master/images/srenamecol1.png" alt=""></p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="pawarbi/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/powerbi/powerquery/queryfolding/2022/09/20/query-folding-audit-powerbi-powerquery.html" hidden></a>
</article>